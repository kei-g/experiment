jobs:
  approve:
    continue-on-error: true
    if: ${{ success() }}
    name: Approve the PR
    needs:
      - bump
    outputs:
      outcome: ${{ steps.approve.outcome }}
    runs-on: ubuntu-latest
    steps:
      - env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          url: ${{ needs.bump.url }}
        id: approve
        name: Approve the PR
        run: |
          gh pr review --approve $url
  bump:
    if: github.event_name == 'push' && github.ref_type == 'branch' && startsWith(github.event.head_commit.message, ':bookmark:\ Bump the version of @kei-g/none to ') == false
    name: Create a pull request bumping the version in order to publish @kei-g/none
    outputs:
      branch: ${{ steps.branch.outputs.name }}
      id: ${{ steps.create-pull-request.outputs.id }}
      message: ${{ steps.branch.outputs.message }}
      url: ${{ steps.create-pull-request.outputs.url }}
      version-from: ${{ steps.version.outputs.from }}
      version-to: ${{ steps.version.outputs.to }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          ref: ${{ github.event.ref }}
      - id: version
        name: Bump the version
        run: |
          cd none
          current=$(jq -Mcr '.version' < package.json)
          version=$(npm version patch --no-git-tag-version)
          version=${version:1}
          echo ::group::Outputs
          {
            echo from=$current
            echo to=$version
          } | tee -a $GITHUB_OUTPUT
          echo ::endgroup::
        shell: bash
      - env:
          current: ${{ steps.version.outputs.from }}
          version: ${{ steps.version.outputs.to }}
        id: branch
        name: Create a branch
        run: |
          branch=kei-g/none-$version
          git checkout -b $branch
          git push origin $branch
          {
            echo name=$branch
            echo "message=:arrow_up: Bump @kei-g/none from $current to $version"
          } | tee -a $GITHUB_OUTPUT
        shell: bash
      - name: Put changes on package.json
        uses: kei-g/github/put-changes@main
        with:
          file: package.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          message: ${{ steps.branch.outputs.message }}
          target-branch: ${{ steps.branch.outputs.name }}
      - env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message: ${{ steps.branch.outputs.message }}
          version_from: ${{ steps.version.outputs.from }}
          version_to: ${{ steps.version.outputs.to }}
        id: create-pull-request
        name: Create a PR
        run: |
          body="This PR bumps the version of @kei-g/none from $version_from to $version_to"
          pull_request_url=$(
            gh pr create \
              --base main \
              --body "$body" \
              --title "$message" \
            | tee >(cat >&2)
          )
          echo ::group::Outputs
          {
            echo "id=${pull_request_url##*/}"
            echo "url=$pull_request_url"
          } | tee -a $GITHUB_OUTPUT
          echo ::endgroup::
        shell: bash
  delete-stale-branch:
    name: Delete stale branch
    needs:
      - bump
      - merge
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - env:
          branch: ${{ needs.bump.outputs.branch }}
        name: Delete the stale branch, ${{ needs.bump.outputs.branch }}
        run: |
          git push origin :$branch
  merge:
    continue-on-error: true
    if: ${{ needs.approve.outcome == 'success' }}
    name: Merge the PR
    needs:
      - approve
      - bump
    outputs:
      outcome: ${{ steps.merge.outcome }}
    runs-on: ubuntu-latest
    steps:
      - env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: merge
        name: "Merge the PR #${{ needs.bump.outputs.id }}"
        run: |
          gh pr merge --auto --merge ${{ needs.bump.outputs.url }}
  publish:
    if: ${{ needs.merge.outputs.outcome == 'success' }}
    name: Publish @kei-g/none
    needs:
      - bump
      - merge
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          cache: npm
          node-version: 19
          registry-url: 'https://registry.npmjs.org'
      - env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        name: Publish @kei-g/none v${{ needs.bump.outputs.version-to }}
        run: |
          cd none
          npm publish
name: Bump @kei-g/none
on:
  push:
    branches:
      - main
    paths:
      - 'none/**'
